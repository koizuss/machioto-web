<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>place2play</title>
<link rel="stylesheet" href="lib/prettyPhoto_compressed_3.1.3/css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="lib/prettyPhoto_compressed_3.1.3/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	var gps = navigator.geolocation;
	var geocoder;
	
	var youtubeSearchUrl = 'http://gdata.youtube.com/feeds/api/videos/$$id?alt=json';
	var youtubeThumbnail = 'http://i.ytimg.com/vi/$$id/default.jpg';
	
	$(function(){
		var searchResult = $('#search-result');
		var auto = $('#auto');
		var results = $('#results');
		var timeout = 10000
		
		var getPosition = function(callback){
			if(auto.attr('checked')){
				gps.getCurrentPosition(
						function(position){
							callback(position.coords.latitude,
									position.coords.longitude);
						},
						function(error){
							alert('code: ' + error.code + ', message: ' + error.message);
						},
						{timeout: timeout});
						// TODO: errorCallback
			}else{
				var place = $('input[name=place]:checked');
				callback(place.nextAll('[name=latitude]').val(),
						place.nextAll('[name=longitude]').val());
			}
		};
		
		var updateEntries = function(entries){
			results.find('dd').remove();
			$(entries).each(function(){
				$('<dd></dd>')
					.append(
						$('<a></a>')
							.attr('href', 'http://www.youtube.com/watch?v=' + this.youtubeId)
							.attr('rel', 'prettyPhoto')
							.attr('title', '')
							.append(
								$('<img />')
									.attr('src', 'http://i.ytimg.com/vi/' + this.youtubeId + '/0.jpg')
									.attr('alt', this.title)
									.attr('height', 90)
									.attr('width', 120)
								)
							.append($('<b></b>').text(this.title))
							.prettyPhoto({theme:'dark_rounded'})
							)
					.appendTo(results);
			});
		};
		
		// TODO: refactering ajax
		var putEntry = function(latitude, longitude){

			var youtubeId = $('#url').val().replace(/.*v=(.+)&?/, '$1');
			
			$.ajax({
				type: 'GET',
				url: 'http://gdata.youtube.com/feeds/api/videos/' + youtubeId,
				dataType: 'json',
				data: {alt: 'json'},
				success: function(result){
					var data = {
		 				'entry.youtubeId': youtubeId,
		 				'entry.title': result.entry.title.$t,
		 				'entry.latitude': latitude,
		 				'entry.longitude': longitude
		 			};
					
					// TODO: callback function
					$.ajax({
						type: 'POST',
						url: '/entry/put',
						dataType: 'json',
						data: data,
						success: function(results){ updateEntries(results) },
						error: function(obj, status, msg){ alert(status + ': ' + msg); },
						timeout: timeout
					});
				},
				error: function(obj, status, msg){ alert(status + ': ' + msg); },
				timeout: timeout
			});
		};
		
		var fetchEntries = function(latitude, longitude){
			var data = {
				latitude: latitude,
				longitude: longitude
			};
			
			// TODO: callback function
			$.ajax({
				type: 'POST',
				url: '/entry/index',
				dataType: 'json',
				data: data,
				success: function(results){ updateEntries(results) },
				error: function(obj, status, msg){ alert(status + ': ' + msg); },
				timeout: timeout
			});
		}
		
		if(gps){
			auto.attr('checked', 'checked');
		}else{
			auto.parent().remove();	
		}
		
		$('#search').click(function(){
			if(!geocoder){
				geocoder = new google.maps.Geocoder();
			}
			// alert(geocoder);
			// TODO: timeout??
			geocoder.geocode( { address: $('#address').val() }, function(results, status) {
				searchResult.find('dd').remove();
				if(status == google.maps.GeocoderStatus.OK){
					// alert('SUCCESS: ' + status);
					$(results).each(function(){
						$('<dd></dd>')
							.append($('<input type="radio" name="place" />'))
							.append($('<lavel></lavel>').text(this.formatted_address))
							.append($('<input type="hidden" name="latitude" />').val(this.geometry.location.lat()))
							.append($('<input type="hidden" name="longitude" />').val(this.geometry.location.lng()))
							.appendTo(searchResult);
						
						searchResult.find('dd:first input:radio').attr('checked', 'checked');
					});
				}else{
					// alert('ERROR: ' + status);
					alert('Can not search place this address');
				}
			});
		});
		
		$('#put-entry').click(function(){
			// TODO: validation
			getPosition(putEntry);
		});
		
		$('#update-entries').click(function(){
			// TODO: validation
			getPosition(fetchEntries);
		});
	});
</script>
</head>
<body>
<p>place2play<p>
<hr>
<div id="place-form">
<p>place</p>
<div>
<input type="radio" name="place" id="auto" />
<label>Auto</label>
</div>
<input type="text" id="address" size="70" />
<button id="search">Search</button>
<dl id="search-result"></dl>
</div>
<hr>
<div id="put-entry-form">
<p>put entry</p>
<input id="url" type="text" size="70">
<button id="put-entry">done</button>
<a href="http://www.youtube.com/" target="_blank">Search on Youtube</a>
</div>
<hr>
<button id="update-entries">update</button>
<dl id="results"></dl>
</body>
</html>
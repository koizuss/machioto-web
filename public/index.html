<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>place2play</title>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="javascripts/jquery-1.5.2.min.js"></script>
<script type="text/javascript">
	var gps = navigator.geolocation;
	var geocoder;
	
	$(function(){
		var searchResult = $('#search-result');
		var auto = $('#auto');
		var results = $('#results');
		
		var getPosition = function(callback){
			if(auto.attr('checked')){
				gps.getCurrentPosition(
						function(position){
							callback(position.coords.latitude,
									position.coords.longitude);
						},
						function(error){
							alert('code: ' + error.code + ', message: ' + error.message);
						},
						{timeout: 10000});
						// TODO: errorCallback
			}else{
				var place = $('input[name=place]:checked');
				callback(place.nextAll('[name=latitude]').val(),
						place.nextAll('[name=longitude]').val());
			}
		};
		
		var updateEntries = function(entries){
			results.find('tr:not(:has(th))').remove();
			$(entries).each(function(){
				$('<tr></tr>')
					.append($('<td></td>').text(this.url))
					.append($('<td></td>').text(this.latitude))
					.append($('<td></td>').text(this.longitude))
					.appendTo(results);
			});
		};
		
		// TODO: refactering ajax
		var putEntry = function(latitude, longitude){
			var data = {
				'entry.url': $('#url').val(),
				'entry.latitude': latitude,
				'entry.longitude': longitude
			};
			
			// TODO: callback function
			$.ajax({
				type: 'POST',
				url: '/entry/put',
				dataType: 'json',
				data: data,
				success: function(results){ updateEntries(results) },
				error: function(obj, status, msg){ alert(status + ': ' + msg); }
			});
		};
		
		var fetchEntries = function(latitude, longitude){
			var data = {
				latitude: latitude,
				longitude: longitude
			};
			
			// TODO: callback function
			$.ajax({
				type: 'POST',
				url: '/entry/index',
				dataType: 'json',
				data: data,
				success: function(results){ updateEntries(results) },
				error: function(obj, status, msg){ alert(status + ': ' + msg); }
			});
		}
		
		if(gps){
			auto.attr('checked', 'checked');
		}else{
			auto.parent().remove();	
		}
		
		$('#search').click(function(){
			if(!geocoder){
				geocoder = new google.maps.Geocoder();
			}
			// alert(geocoder);
			geocoder.geocode( { address: $('#address').val() }, function(results, status) {
				searchResult.find('dd').remove();
				if(status == google.maps.GeocoderStatus.OK){
					// alert('SUCCESS: ' + status);
					$(results).each(function(){
						$('<dd></dd>')
							.append($('<input type="radio" name="place" />'))
							.append($('<lavel></lavel>').text(this.formatted_address))
							.append($('<input type="hidden" name="latitude" />').val(this.geometry.location.lat()))
							.append($('<input type="hidden" name="longitude" />').val(this.geometry.location.lng()))
							.appendTo(searchResult);
						
						searchResult.find('dd:first input:radio').attr('checked', 'checked');
					});
				}else{
					// alert('ERROR: ' + status);
					alert('Can not search place this address');
				}
			});
		});
		
		$('#put-entry').click(function(){
			// TODO: validation
			getPosition(putEntry);
		});
		
		$('#update-entries').click(function(){
			// TODO: validation
			getPosition(fetchEntries);
		});
	});
</script>
</head>
<body>
<p>place2play<p>
<hr>
<div id="place-form">
<p>place</p>
<div>
<input type="radio" name="place" id="auto" />
<label>Auto</label>
</div>
<input type="text" id="address" size="70" />
<button id="search">Search</button>
<dl id="search-result"></dl>
</div>
<hr>
<div id="put-entry-form">
	<p>put entry</p>
	<input id="url" type="text" size="70">
	<button id="put-entry">done</button>
</div>
<hr>
<button id="update-entries">update</button>
<table id="results">
<tr>
<th>url</th>
<th>latitude</th>
<th>longitude</th>
</tr>
</table>
</body>
</html>